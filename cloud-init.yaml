#cloud-config

# =============================================================================
# Basic System Configuration
# =============================================================================

hostname: ${domain}
timezone: ${timezone}
locale: en_US.UTF-8

# =============================================================================
# User Configuration
# =============================================================================

users:
  - name: ${admin_username}
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) ALL
    lock_passwd: false
    ssh_authorized_keys:
      - ${ssh_public_key}

disable_root: true

# =============================================================================
# SSH Hardening
# =============================================================================

ssh_pwauth: false
ssh_deletekeys: true
ssh_genkeytypes: [ed25519, rsa]

# =============================================================================
# Packages
# =============================================================================

package_update: true
package_upgrade: true
package_reboot_if_required: false

packages:
  # Essentials
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - software-properties-common
  # Security
  - fail2ban
  - ufw
  - unattended-upgrades
  - apt-listchanges
  - auditd
  - audispd-plugins
  - apparmor
  - apparmor-utils
  # Tools
  - htop
  - ncdu
  - tree
  - jq
  - git
  - vim
  - tmux
  - net-tools
  - dnsutils

# =============================================================================
# Write Files
# =============================================================================

write_files:
  # SSH Hardening Config
  - path: /etc/ssh/sshd_config.d/hardening.conf
    permissions: '0644'
    content: |
      PermitRootLogin no
      PasswordAuthentication no
      PubkeyAuthentication yes
      AuthenticationMethods publickey
      MaxAuthTries 3
      MaxSessions 3
      ClientAliveInterval 300
      ClientAliveCountMax 2
      X11Forwarding no
      AllowTcpForwarding no
      AllowAgentForwarding no
      PermitEmptyPasswords no
      Protocol 2
      Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
      MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com
      HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256,ssh-rsa
      KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512
      LoginGraceTime 30
      IgnoreRhosts yes
      HostbasedAuthentication no

  # Fail2Ban SSH Jail
  - path: /etc/fail2ban/jail.local
    permissions: '0644'
    content: |
      [DEFAULT]
      bantime = 604800
      findtime = 3600
      maxretry = 3
      ignoreip = 127.0.0.1/8 ::1
      destemail = ${admin_email}
      sender = fail2ban@${domain}
      action = %(banaction)s[name=%(__name__)s, bantime="%(bantime)s", port="%(port)s", protocol="%(protocol)s", chain="%(chain)s"]
               %(mta)s-whois[name=%(__name__)s, dest="%(destemail)s", sender="%(sender)s"]

      [sshd]
      enabled = true
      port = ssh
      logpath = %(sshd_log)s
      backend = %(sshd_backend)s
      maxretry = 3
      bantime = 604800

  # Automatic Security Updates
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    permissions: '0644'
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "$${distro_id}:$${distro_codename}-security";
          "$${distro_id}ESMApps:$${distro_codename}-apps-security";
          "$${distro_id}ESM:$${distro_codename}-infra-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Mail "${admin_email}";
      Unattended-Upgrade::MailReport "on-change";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";

  - path: /etc/apt/apt.conf.d/20auto-upgrades
    permissions: '0644'
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";

  # Kernel Hardening
  - path: /etc/sysctl.d/99-security.conf
    permissions: '0644'
    content: |
      # IP Spoofing protection
      net.ipv4.conf.all.rp_filter = 1
      net.ipv4.conf.default.rp_filter = 1
      # SYN cookies (SYN flood protection)
      net.ipv4.tcp_syncookies = 1
      net.ipv4.tcp_max_syn_backlog = 2048
      net.ipv4.tcp_synack_retries = 2
      # ICMP redirects
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv4.conf.default.accept_redirects = 0
      net.ipv4.conf.all.send_redirects = 0
      net.ipv4.conf.default.send_redirects = 0
      # Source routing
      net.ipv4.conf.all.accept_source_route = 0
      net.ipv4.conf.default.accept_source_route = 0
      # Logging
      net.ipv4.conf.all.log_martians = 1
      net.ipv4.icmp_echo_ignore_broadcasts = 1
      # Kernel hardening
      kernel.dmesg_restrict = 1
      kernel.kptr_restrict = 2
      kernel.randomize_va_space = 2
      kernel.perf_event_paranoid = 2
      # Disable TCP timestamps (fingerprinting)
      net.ipv4.tcp_timestamps = 0
      # ARP hardening
      net.ipv4.conf.all.arp_ignore = 1
      net.ipv4.conf.all.arp_announce = 2
      # Swap hardening
      vm.swappiness = 10
      vm.panic_on_oom = 0
      # Network hardening
      net.ipv4.ip_forward = 0
      net.ipv4.conf.all.src_valid_mark = 1
      net.ipv4.icmp_ignore_bogus_error_responses = 1
      # Connection tracking
      net.netfilter.nf_conntrack_max = 262144
      net.netfilter.nf_conntrack_tcp_timeout_established = 1800
      # Time-wait sockets recycle
      net.ipv4.tcp_tw_reuse = 1
      net.ipv4.tcp_fin_timeout = 30

  # Docker daemon configuration
  - path: /etc/docker/daemon.json
    permissions: '0644'
    content: |
      {
        "log-driver": "json-file",
        "log-opts": { "max-size": "10m", "max-file": "3" },
        "live-restore": true,
        "userland-proxy": false,
        "no-new-privileges": true
      }

  # Login MOTD
  - path: /etc/motd
    permissions: '0644'
    content: |+
      
      ##
      ## ${domain}
      ##
      ## UNAUTHORIZED ACCESS IS PROHIBITED!
      ##
      ## All connections are monitored and logged.
      ##

  # Clear SSH login banners
  - path: /etc/issue
    permissions: '0644'
    content: ""

  - path: /etc/issue.net
    permissions: '0644'
    content: ""

  # Bash aliases
  - path: /home/${admin_username}/.bash_aliases
    permissions: '0644'
    owner: ${admin_username}:${admin_username}
    defer: true
    content: |
      alias d='docker'
      alias dc='docker compose'
      alias dps='docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'
      alias dlogs='docker compose logs -f'
      alias ll='ls -alF'
      alias security-check='sudo /usr/local/bin/security-check'

  # Security check script
  - path: /usr/local/bin/security-check
    permissions: '0755'
    content: |
      #!/bin/bash
      echo "========================================"
      echo "        SECURITY STATUS CHECK"
      echo "========================================"
      echo ""

      echo "------------------ Fail2Ban ------------------"
      fail2ban-client status sshd 2>/dev/null || echo "Not running"
      echo ""

      echo "--------------------- UFW --------------------"
      ufw status
      echo ""

      echo "------------------ Auditd -------------------"
      aureport -au 2>/dev/null | head -10 || echo "Auditd not running"
      echo ""

      echo "----------------- AppArmor -----------------"
      aa-status 2>/dev/null | grep -E "profiles are in|processes are" || echo "AppArmor not running"
      echo ""

      echo "------------------ Docker -------------------"
      docker ps --format "table {{.Names}}\t{{.Status}}"
      echo ""

      echo "------------------- Redis ------------------"
      docker exec wordpress-redis redis-cli info stats 2>/dev/null | grep -E "keyspace_hits|keyspace_misses" || echo "Redis not running"
      echo ""

      echo "---------------- Resources -----------------"
      echo "Disk: $(df -h / | tail -1 | awk '{print $5 " used"}')"
      echo "Memory: $(free -h | awk '/^Mem:/ {print $3 "/" $2}')"
      echo ""
      echo "========================================"

  # ==========================================================================
  # Traefik Configuration
  # ==========================================================================

  - path: /opt/traefik/traefik.yml
    permissions: '0644'
    content: |
      global:
        checkNewVersion: false
        sendAnonymousUsage: false
      api:
        dashboard: false
      ping: {}
      entryPoints:
        web:
          address: ":80"
          http:
            redirections:
              entryPoint:
                to: websecure
                scheme: https
                permanent: true
        websecure:
          address: ":443"
          http:
            tls:
              certResolver: letsencrypt
            middlewares:
              - security-headers@file
              - rate-limit@file
      providers:
        docker:
          endpoint: "unix:///var/run/docker.sock"
          exposedByDefault: false
          network: traefik
        file:
          directory: /etc/traefik/config
          watch: true
      certificatesResolvers:
        letsencrypt:
          acme:
            email: ${admin_email}
            storage: /letsencrypt/acme.json
            httpChallenge:
              entryPoint: web
      log:
        level: INFO
      accessLog:
        bufferingSize: 100

  - path: /opt/traefik/config/dynamic.yml
    permissions: '0644'
    content: |
      http:
        middlewares:
          security-headers:
            headers:
              browserXssFilter: true
              contentTypeNosniff: true
              forceSTSHeader: true
              stsIncludeSubdomains: true
              stsPreload: true
              stsSeconds: 31536000
              customFrameOptionsValue: "SAMEORIGIN"
              referrerPolicy: "strict-origin-when-cross-origin"
              permissionsPolicy: "camera=(), microphone=(), geolocation=(), payment=()"
              contentSecurityPolicy: "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; frame-ancestors 'self';"
              customResponseHeaders:
                X-Powered-By: ""
                Server: ""
          rate-limit:
            rateLimit:
              average: 100
              burst: 50
              period: 1s
          compress:
            compress: {}

  - path: /opt/traefik/docker-compose.yml
    permissions: '0644'
    content: |
      services:
        traefik:
          image: traefik:v3.6
          container_name: traefik
          restart: unless-stopped
          environment:
            - DOCKER_API_VERSION=1.45
          security_opt:
            - no-new-privileges:true
          ports:
            - "80:80"
            - "443:443"
          volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - ./traefik.yml:/etc/traefik/traefik.yml:ro
            - ./config:/etc/traefik/config:ro
            - traefik-ssl:/letsencrypt
          networks:
            - traefik
          healthcheck:
            test: ["CMD", "traefik", "healthcheck", "--ping"]
            interval: 30s
            timeout: 5s
            retries: 3
      volumes:
        traefik-ssl:
      networks:
        traefik:
          external: true

  # ==========================================================================
  # WordPress Configuration
  # ==========================================================================

  - path: /opt/wordpress/docker-compose.yml
    permissions: '0644'
    content: |
      services:
        db:
          image: mariadb:11
          container_name: wordpress-db
          restart: unless-stopped
          command: >
            --character-set-server=utf8mb4
            --collation-server=utf8mb4_unicode_ci
            --skip-log-bin
            --local-infile=0
            --skip-symbolic-links
            --max-connections=100
          environment:
            MYSQL_ROOT_PASSWORD: $${DB_ROOT_PASSWORD}
            MYSQL_DATABASE: $${DB_NAME}
            MYSQL_USER: $${DB_USER}
            MYSQL_PASSWORD: $${DB_PASSWORD}
          volumes:
            - db_data:/var/lib/mysql
          networks:
            - wordpress-internal
          healthcheck:
            test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
            interval: 30s
            timeout: 5s
            retries: 5
            start_period: 30s
          security_opt:
            - no-new-privileges:true

        redis:
          image: redis:7-alpine
          container_name: wordpress-redis
          restart: unless-stopped
          command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
          volumes:
            - redis_data:/data
          networks:
            - wordpress-internal
          healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 30s
            timeout: 5s
            retries: 3
          security_opt:
            - no-new-privileges:true

        wordpress:
          image: wordpress:6-fpm-alpine
          container_name: wordpress-app
          restart: unless-stopped
          depends_on:
            db:
              condition: service_healthy
            redis:
              condition: service_healthy
          environment:
            WORDPRESS_DB_HOST: db:3306
            WORDPRESS_DB_NAME: $${DB_NAME}
            WORDPRESS_DB_USER: $${DB_USER}
            WORDPRESS_DB_PASSWORD: $${DB_PASSWORD}
            WORDPRESS_TABLE_PREFIX: $${WP_TABLE_PREFIX:-wp_}
            PHP_UPLOAD_MAX_FILESIZE: 64M
            PHP_POST_MAX_SIZE: 64M
            WORDPRESS_AUTH_KEY: $${WP_AUTH_KEY}
            WORDPRESS_SECURE_AUTH_KEY: $${WP_SECURE_AUTH_KEY}
            WORDPRESS_LOGGED_IN_KEY: $${WP_LOGGED_IN_KEY}
            WORDPRESS_NONCE_KEY: $${WP_NONCE_KEY}
            WORDPRESS_AUTH_SALT: $${WP_AUTH_SALT}
            WORDPRESS_SECURE_AUTH_SALT: $${WP_SECURE_AUTH_SALT}
            WORDPRESS_LOGGED_IN_SALT: $${WP_LOGGED_IN_SALT}
            WORDPRESS_NONCE_SALT: $${WP_NONCE_SALT}
            WORDPRESS_CONFIG_EXTRA: |
              define('DISALLOW_FILE_EDIT', true);
              define('FORCE_SSL_ADMIN', true);
              define('WP_AUTO_UPDATE_CORE', 'minor');
              define('WP_MEMORY_LIMIT', '512M');
              define('WP_REDIS_HOST', 'redis');
              define('WP_REDIS_PORT', 6379);
              define('WP_REDIS_DATABASE', 0);
              define('WP_CACHE', true);
          volumes:
            - wordpress_data:/var/www/html
            - ./php-uploads.ini:/usr/local/etc/php/conf.d/uploads.ini:ro
          networks:
            - wordpress-internal
            - traefik
          healthcheck:
            test: ["CMD-SHELL", "pgrep php-fpm > /dev/null"]
            interval: 30s
            timeout: 5s
            retries: 3
          security_opt:
            - no-new-privileges:true
          extra_hosts:
            - "${domain}:host-gateway"

        nginx:
          image: nginx:1.25-alpine
          container_name: wordpress-nginx
          restart: unless-stopped
          depends_on:
            wordpress:
              condition: service_healthy
          volumes:
            - wordpress_data:/var/www/html:ro
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
          networks:
            - wordpress-internal
            - traefik
          healthcheck:
            test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1/nginx-health"]
            interval: 30s
            timeout: 5s
            retries: 3
          security_opt:
            - no-new-privileges:true
          labels:
            - "traefik.enable=true"
            - "traefik.http.routers.wordpress.rule=Host(`${domain}`) || Host(`www.${domain}`)"
            - "traefik.http.routers.wordpress.entrypoints=websecure"
            - "traefik.http.routers.wordpress.tls=true"
            - "traefik.http.routers.wordpress.tls.certresolver=letsencrypt"
            - "traefik.http.routers.wordpress.middlewares=security-headers@file,rate-limit@file,compress@file"
            - "traefik.http.services.wordpress.loadbalancer.server.port=80"

        wpcli:
          image: wordpress:cli
          container_name: wordpress-wpcli
          environment:
            WORDPRESS_DB_HOST: db:3306
            WORDPRESS_DB_NAME: $${DB_NAME}
            WORDPRESS_DB_USER: $${DB_USER}
            WORDPRESS_DB_PASSWORD: $${DB_PASSWORD}
            WORDPRESS_TABLE_PREFIX: $${WP_TABLE_PREFIX:-wp_}
            WORDPRESS_CONFIG_EXTRA: |
              define('WP_REDIS_HOST', 'redis');
              define('WP_REDIS_PORT', 6379);
              define('WP_REDIS_DATABASE', 0);
              define('WP_CACHE', true);
          volumes:
            - wordpress_data:/var/www/html
          networks:
            - wordpress-internal
          depends_on:
            db:
              condition: service_healthy
            wordpress:
              condition: service_healthy
          profiles:
            - tools

      volumes:
        db_data:
        wordpress_data:
        redis_data:

      networks:
        wordpress-internal:
          driver: bridge
          internal: true
        traefik:
          external: true

  - path: /opt/wordpress/php-uploads.ini
    permissions: '0644'
    content: |
      ; PHP Upload Limits for WordPress Media Library
      upload_max_filesize = 64M
      post_max_size = 64M
      max_file_uploads = 20
      max_execution_time = 300
      max_input_time = 300
      memory_limit = 512M

  - path: /opt/wordpress/nginx.conf
    permissions: '0644'
    content: |
      user nginx;
      worker_processes auto;
      error_log /var/log/nginx/error.log warn;
      pid /var/run/nginx.pid;
      events { worker_connections 1024; }
      http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        sendfile on;
        keepalive_timeout 65;
        server_tokens off;
        client_max_body_size 64M;
        gzip on;
        gzip_vary on;
        gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;
        upstream php-fpm { server wordpress:9000; }
        server {
          listen 80;
          root /var/www/html;
          index index.php;
          location = /nginx-health { access_log off; return 200 "healthy\n"; }

          # Security blocks FIRST (before general .php handler)
          location ~ /\. { deny all; }
          location ~ /wp-config\.php { deny all; }
          location ~ /xmlrpc\.php { deny all; }
          location ~* /wp-content/uploads/.*\.php$ { deny all; }

          location / { try_files $uri $uri/ /index.php?$args; }
          location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass php-fpm;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
          }
          location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
          }
        }
      }

  - path: /opt/wordpress/.env.example
    permissions: '0644'
    content: |
      # Database
      DB_ROOT_PASSWORD=CHANGE_ME
      DB_NAME=wordpress
      DB_USER=wordpress
      DB_PASSWORD=CHANGE_ME

      # WordPress Table Prefix
      WP_TABLE_PREFIX=wp_

      # WordPress Keys - Generate at: https://api.wordpress.org/secret-key/1.1/salt/
      WP_AUTH_KEY='CHANGE_ME'
      WP_SECURE_AUTH_KEY='CHANGE_ME'
      WP_LOGGED_IN_KEY='CHANGE_ME'
      WP_NONCE_KEY='CHANGE_ME'
      WP_AUTH_SALT='CHANGE_ME'
      WP_SECURE_AUTH_SALT='CHANGE_ME'
      WP_LOGGED_IN_SALT='CHANGE_ME'
      WP_NONCE_SALT='CHANGE_ME'

  - path: /opt/wordpress/setup.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      cd "$(dirname "$0")"

      DOMAIN="${domain}"
      SERVER_IP=$(curl -4 -s ifconfig.me)

      echo "=== WordPress Setup ==="
      echo ""

      # Check DNS resolution (using external DNS to avoid /etc/hosts)
      echo "Checking DNS for $DOMAIN..."
      RESOLVED_IP=$(dig +short $DOMAIN @1.1.1.1 | tail -n1)

      if [ -z "$RESOLVED_IP" ]; then
        echo ""
        echo "ERROR: $DOMAIN does not resolve to any IP address."
        echo ""
        echo "Please configure your DNS first:"
        echo "  A record: $DOMAIN -> $SERVER_IP"
        echo "  A record: www.$DOMAIN -> $SERVER_IP"
        echo ""
        echo "Then wait for DNS propagation (5-30 min) and run this script again."
        exit 1
      fi

      if [ "$RESOLVED_IP" != "$SERVER_IP" ]; then
        echo ""
        echo "ERROR: $DOMAIN resolves to $RESOLVED_IP, but this server is $SERVER_IP"
        echo ""
        echo "Please update your DNS:"
        echo "  A record: $DOMAIN -> $SERVER_IP"
        echo ""
        echo "Then wait for DNS propagation and run this script again."
        exit 1
      fi

      echo "DNS OK: $DOMAIN -> $SERVER_IP"
      echo ""

      # Start Traefik (if not running)
      if ! docker ps | grep -q traefik; then
        echo "Starting Traefik..."
        docker network create traefik 2>/dev/null || true
        cd /opt/traefik && docker compose up -d
        echo "Waiting for Traefik to be ready..."
        sleep 5
        cd /opt/wordpress
      else
        echo "Traefik already running."
      fi

      # Generate .env if needed
      if [ ! -f .env ]; then
        echo "Generating .env with secure passwords..."

        {
          echo "# Database"
          echo "DB_ROOT_PASSWORD=$(openssl rand -hex 32)"
          echo "DB_NAME=wordpress"
          echo "DB_USER=wordpress"
          echo "DB_PASSWORD=$(openssl rand -hex 32)"
          echo ""
          echo "# WordPress Table Prefix"
          echo "WP_TABLE_PREFIX=wp_"
          echo ""
          echo "# WordPress Keys"
          echo "WP_AUTH_KEY=$(openssl rand -hex 32)"
          echo "WP_SECURE_AUTH_KEY=$(openssl rand -hex 32)"
          echo "WP_LOGGED_IN_KEY=$(openssl rand -hex 32)"
          echo "WP_NONCE_KEY=$(openssl rand -hex 32)"
          echo "WP_AUTH_SALT=$(openssl rand -hex 32)"
          echo "WP_SECURE_AUTH_SALT=$(openssl rand -hex 32)"
          echo "WP_LOGGED_IN_SALT=$(openssl rand -hex 32)"
          echo "WP_NONCE_SALT=$(openssl rand -hex 32)"
        } > .env

        echo ".env generated!"
      fi

      echo ""
      echo "Starting WordPress..."
      docker compose up -d

      echo ""
      echo "Configuring WP-Cron..."
      # Disable WP-Cron and set up system cron for better reliability
      sleep 5
      docker compose exec -T wordpress sh -c "echo \"define('DISABLE_WP_CRON', true);\" >> /var/www/html/wp-config.php"

      # Add system cron job
      if ! crontab -l 2>/dev/null | grep -q "wp-cron"; then
        (crontab -l 2>/dev/null; echo "*/5 * * * * cd /opt/wordpress && docker compose --profile tools run --rm wpcli wp cron event run --due-now --allow-root > /dev/null 2>&1") | crontab -
        echo "System cron configured for WP-Cron"
      fi

      echo ""
      echo "=== Done ==="
      echo ""
      echo "6.  Verify all containers are running and healthy:"
      echo "    docker ps"
      echo ""
      echo "7.  Check Traefik logs for SSL certificate issuance:"
      echo "    docker logs traefik"
      echo ""
      echo "8.  Visit to complete WordPress installation:"
      echo "    https://${domain}"
      echo ""
      echo "=== Redis Cache Setup ==="
      echo ""      
      echo "9.  In Wordpress add, install and activate the Redis Object Cache plugin by Till KrÃ¼ss"
      echo ""
      echo "10. Enable Object Cache in the plugin"
      echo ""

# =============================================================================
# Run Commands
# =============================================================================

runcmd:
  # Set admin password
  - echo "${admin_username}:${admin_password}" | chpasswd

  # Remove default Ubuntu MOTD scripts (prevents dynamic MOTD generation)
  - rm -rf /etc/update-motd.d/*

  # Set hostname
  - echo "${domain}" > /etc/hostname && hostname -F /etc/hostname

  # Apply sysctl
  - sysctl --system

  # UFW Firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow http
  - ufw allow https
  - ufw --force enable

  # Start services
  - systemctl enable fail2ban && systemctl start fail2ban
  - systemctl restart sshd
  - systemctl enable unattended-upgrades && systemctl start unattended-upgrades
  - systemctl enable auditd && systemctl start auditd
  - systemctl enable apparmor && systemctl start apparmor

  # Install Docker
  - curl -fsSL https://get.docker.com | sh
  - systemctl enable docker && systemctl start docker

  # Create directories
  - mkdir -p /opt/traefik/config
  - mkdir -p /opt/wordpress

  # Create Docker network
  - docker network create traefik || true

  # Fix permissions
  - chown -R ${admin_username}:${admin_username} /home/${admin_username}

  # Disable sudo hint for admin user
  - touch /home/${admin_username}/.sudo_as_admin_successful
  - chown ${admin_username}:${admin_username} /home/${admin_username}/.sudo_as_admin_successful

  # Mark completion
  - touch /var/log/cloud-init-complete
  - echo "Cloud-init completed at $(date)" >> /var/log/cloud-init-complete

# =============================================================================
# Final Message
# =============================================================================

final_message: |
  ===========================================
  Cloud-init completed for ${domain}

  Next steps:
  1. Configure DNS: ${domain} -> this server's IP
  2. Run: cd /opt/wordpress && sudo ./setup.sh
  ===========================================
